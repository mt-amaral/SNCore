@page "/hardware/edit/{hardwareId:int}"

@inject HardwareApi hardwareApi
@inject SnmpApi snmpApi
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False">
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Hardware">
            <MudGrid>
                <MudItem xs="12" sm="7">
                    <MudPaper Class="pa-4">
                        <EditForm Model="@hardwareEdit" OnValidSubmit="HandleValidSubmit">
                            <MudTextField @bind-Value="hardwareEdit.Name" Label="Name" Required="true" />
                            <MudTextField @bind-Value="hardwareEdit.Description" Label="Description" Required="true" />
                            <MudTextField @bind-Value="hardwareEdit.Model" Label="Model" Required="true" />
                            <MudTextField @bind-Value="hardwareEdit.Ipv4" Label="IPv4" Required="true" />
                        </EditForm>
                    </MudPaper>
                    <MudPaper Class="pa-4 mt-4">
                        <MudButton OnClick="HandleValidSubmit" Variant="Variant.Outlined">Salvar</MudButton>
                        <MudButton OnClick="Cancel" Color="Color.Secondary">Cancel</MudButton>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
        <MudTabPanel Text="SNMP">
            <MudGrid>
                <MudItem xs="12" sm="3">
                    <MudPaper Class="pa-1">
                        <EditForm Model="@hardwareSnmp" OnValidSubmit="HandleValidSubmit">
                            <MudTextField @bind-Value="hardwareSnmp.Version" Label="Version" Required="true" />
                            <MudTextField @bind-Value="hardwareSnmp.Community" Label="Community" Required="true" />
                            <MudTextField @bind-Value="hardwareSnmp.Port" Label="Port" Required="true" />
                        </EditForm>
                    </MudPaper>
                    <MudPaper Class="pa-4 mt-4">
                        <MudButton OnClick="HandleValidSubmit" Variant="Variant.Outlined">Salvar</MudButton>
                        <MudButton OnClick="Cancel" Color="Color.Secondary">Cancel</MudButton>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    [Parameter] public int hardwareId { get; set; }
    private HardwareResponse hardwareEdit = new HardwareResponse();
    private HardwareRequest hardwareEdited = new HardwareRequest();
    private HardwareValidation validator = new HardwareValidation();

    private SnmpResponse hardwareSnmp = new SnmpResponse();

    protected override async Task OnInitializedAsync()
    {
        hardwareEdit = await hardwareApi.GetHardwareId(hardwareId);
        hardwareSnmp = await snmpApi.SelectByHardware(hardwareId);
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var validationResult = validator.Validate(hardwareEdit);
            if (!validationResult.IsValid)
            {
                foreach (var error in validationResult.Errors)
                {
                    Snackbar.Add(error.ErrorMessage, Severity.Error);
                }
                return;
            }
            hardwareEdited = Mapper.MapperToJson(hardwareEdit);
            await hardwareApi.EditHardwareAsync(hardwareEdited);
            NavigationManager.NavigateTo("/hardware");
        }
        catch (Exception ex)
        {
            Snackbar.Add("Ocorreu um erro ao tentar salvar o hardware.", Severity.Error);
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/hardware");
    }
}
